## 虚拟文件系统

为了支持不同种类的文件系统，linux 使用虚拟文件系统 VFS 屏蔽下层各种不同类型的文件系统的实现细节和差异。

## 主要数据结构

`inode`，表示文件系统中的一个节点(文件或目录)。

`dentry`，表示文件系统中的一个目录项，存放在内存中，用于缓存路径名解析的结果，以加速文件查找。

`file`，表示一个打开的文件，同一个文件可以有多个对应的 `file`。

`vfsmount`，表示一个挂载点。

`fs_struct`，进程的文件系统上下文。

#### 文件操作函数

这个虚拟文件系统的核心是一个 `file_operations` 结构，实际上是一张函数跳转表。

```cpp
// include/linux/fs.h

struct file_operations {
	struct module *owner;
	fop_flags_t fop_flags;
	loff_t (*llseek)(struct file *, loff_t, int);
	ssize_t (*read)(struct file *, char __user *, size_t, loff_t *);
	ssize_t (*write)(struct file *, const char __user *, size_t, loff_t *);

    ...
};
```

每个文件系统都需要定义当前的 `file_operations` 表，以统一 VFS 调用，如 ext2。

```cpp
// fs/ext2/file.c

const struct file_operations ext2_file_operations = {
	.llseek = generic_file_llseek,
	.read_iter = ext2_file_read_iter,
	.write_iter = ext2_file_write_iter,

    ...
};
```

#### 进程

每个进程中都维护了文件相关的信息。

```cpp
// include/linux/sched.h

struct task_struct {
    ...

	/* Filesystem information: */
	struct fs_struct *fs;

	/* Open file information: */
	struct files_struct *files;

    ...
};
```

`fs_struct` 维护当前进程在文件系统中的一些信息。

```cpp
// include/linux/fs_struct.h

struct fs_struct {
	int users;
	spinlock_t lock;
	seqcount_spinlock_t seq;
	int umask;
	int in_exec;
	struct path root, pwd;
};

// include/linux/path.h

struct path {
	struct vfsmount *mnt;
	struct dentry *dentry;
};
```

`files_struct` 维护与当前进程建立连接的文件的信息。

```cpp
// include/linux/fdtable.h

struct files_struct {
	atomic_t count;
	bool resize_in_progress;
	wait_queue_head_t resize_wait;

	struct fdtable __rcu *fdt;
	struct fdtable fdtab;

	spinlock_t file_lock ____cacheline_aligned_in_smp;
	unsigned int next_fd;
	unsigned long close_on_exec_init[1];
	unsigned long open_fds_init[1];
	unsigned long full_fds_bits_init[1];
	struct file __rcu *fd_array[NR_OPEN_DEFAULT];
};
```
