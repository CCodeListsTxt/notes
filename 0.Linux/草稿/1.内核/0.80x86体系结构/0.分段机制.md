#### 简介

* 分段机制是80x86CPU上内存管理机制的第一部分，其负责将逻辑地址转换为线性地址——`线性地址 = 段基地址 + 逻辑地址`。

  分段机制将虚拟地址中的虚拟内存组织成一些长度可变的内存单元块——段。

* 段的组成：

  * 段基地址。
  * 段限长：虚拟地址空间中段内最大可用偏移量——段长度。
  * 段属性：可读、可写、可执行、特权级等。

  段基地址、段限长、段属性被存放在一个称为**段描述符**的数据结构中，段描述符保存在内存中的**段描述符表**中。

* 不同段映射到物理地址中的范围可以部分重叠甚至完全覆盖。

---

#### 段描述符表

* 段描述符表是段描述符的数组，最多可存放8192个8字节段描述符。

  一共有两种描述符表：**全局描述符[^1]**，**局部描述符[^2]**。

* 描述符存储在操作系统维护的数据结构中，由处理器的内存管理硬件引用。虚拟地址空间被分割为大小相等的两部分，一部分由GDT映射，另一部分由LDT映射。

* 系统中每个程序拥有自己的LDT，所有程序共享GDT。

    ```mermaid
    graph TD
        gdt[GDT]
        ldt_a[LDT_A]
    
        code_os[code_os]
        data_os[data_os]
    
        ldt_b[LDT_B]
    
        code_a[code_a]
        data_a[data_a]
    
        code_b[code_b]
        data_b[data_b]
    
        gdt --> ldt_a
        gdt --> ldt_b
        gdt --> code_os
        gdt --> data_os
    
        ldt_a --> code_a
        ldt_a --> data_a
    
        ldt_b --> code_b
        ldt_b --> data_b
    ```

* GDT本身并不是一个段，而是存放在物理内存中的一个数据结构。其起始地址和长度值存放在`GDTR`寄存器中。

  处理器并不使用GDT中的第一项，指向该位置的选择符用作空选择符。

---

#### 段选择符

* 段选择符是一个16位标识符，不直接指向段，而是指向段描述符表中定义段的描述符。

* 段描述符格式：
  ![image-20221122202251906](../../../999.asset/image-20221122202251906.png)
  * RPL，2bit，请求特权，`Request Privilege Level`。
  * TI，1bit，表指示标志，`Table Index`。
  * 索引值。

---

#### 段描述符

* 每个段描述符为8字节，主要包含三个字段：段基地址、段限长和段属性。

* 段描述符通用格式：

  ![image-20221122170501495](../../../999.asset/image-20221122170501495.png)

  * 段限长，20bit。由颗粒度G指定段限长数值代表的意义：
    * `G=0，单位=1，范围1B~1MB`。
    * `G=1，单位=4KB，范围4KB~4GB`。
  * 基地址，32bit。
  * Type，4bit。指定段类型、段访问种类和段拓展方向。
  * S，1bit。`s=0，系统段描述符`；`s=1，代码段或数据段描述符`。
  * DPL，2bit。段权限级，0最高，3最低。
  * P，1bit。`p=0，段不在内存中`；`p=1，段在内存中`。
  * AVL，1bit。可被软件使用，硬件忽略。
  * R，1bit。保留位，总是置为0。











[^1]:Global Descriptor Table，GDT
[^2]:Local Descriptor Table，LDT
