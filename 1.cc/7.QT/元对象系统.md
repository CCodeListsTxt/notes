[toc]

## MOC

Meta-Object-Compiler工具，会读取c++源文件，当其找到[QObject]()的派生类，且其内部包含[Q_OBJECT]()宏时，会生成另一份c++代码，其中包含该类的元对象代码。

## QMetaObject

[QMetaObject]()存储Qt对象的元信息，负责处理信号槽机制、运行时类型信息、Qt属性系统等。

### 获取

有两种方式获取当前类或对象的[QMetaObject]()对象：[示例](#示例1)

* 静态成员，[QObject::staticMetaObject]()。
* 成员函数，[QObject::metaObject()]()，返回指针。

成员函数，[QMetaObject::superClass()]()，返回基类[QMetaObject]()的指针。

## 附加信息

定义[QObject]()派生类时，内部可包含宏[Q_CLASSINFO(name, value)]()，存放类相关信息。其通过[QMetaClassInfo]()类存储，可通过[.name()]()和[.value()]()访问。且子类会继承父类的类信息。

成员函数，[QMetaObject::classInof(idx)]()，获取指定索引的类信息。

成员函数，[QMetaObject::classInfoCount()]()，获取类信息数量。

成员函数，[QMetaObject::classInfoOffset()]()，获取当前类第一个类信息索引的偏移量。

## 属性系统

Qt的属性系统可以将类内部属性暴露出来，成为一种通用的信息。属性可以在c++和qml中交互。

### 声明属性

使用[Q_PROPERTY(type name)]()作为声明属性的基本形式，此外，还可以为其提供读、写、绑定成员变量、关联信号等操作。其语法如下：

```cpp
Q_PROPERTY(type name
          [MEMBER member_name]	// 绑定成员变量
          [READ getter]			// 读取器
          [WRITE setter]		// 写入器
          [NOTIFY signal]		// 关联信号
          [RESET reset]			// 重置属性
          [CONSTANT]			// 标记为常量属性 
          [FINAL]				// 标记该属性不会被覆盖(用于优化处理，而不是强制要求)
          )
```

* 如果未指定_MEMBER_，则必须提供_READ_。
* 指定_MEMBER_后，属性默认可读可写。如果需要控制属性访问，只能单独设置_READ_或_WRITE_，不能同时设置两者。
* _WRITE_的其参数可以是属性类型、指针或引用。
* _RESET_提供将属性重置的函数。
* 如果指定_NOTIFY_关联信号，当通过QtAPI或QML修改属性时，都会发送该信号。信号必须接受零个或一个参数，且必须与属性类型相同。[示例](#示例2)

### 读写属性

成员函数，[QObject::property(name)]()，读取属性。

成员函数，[QObject::setProperty(name, value)]()，设置属性[^1]。







# 示例

## 示例1

```cpp
auto main(int argc, char* argv[]) -> int {
    auto app = QCoreApplication{argc, argv};

    std::cout
        << (app.metaObject() == &QCoreApplication::staticMetaObject)    // true
        << "\n";

    return QCoreApplication::exec();
}
```

## 示例2

```cpp
struct Data : public QObject {
    Q_OBJECT
    Q_PROPERTY(int data MEMBER m_data NOTIFY data_changed)

  signals:
    auto data_changed(int) -> void;

  public:
    int m_data;
};

auto main(int argc, char *argv[]) -> int {
    auto app = QCoreApplication{argc, argv};

    auto data = Data{};
    QObject::connect(&data, &Data::data_changed, [&](int new_data) {
        std::cout << std::format("new data = {}\n", new_data);
    });

    data.setProperty("data", 20);  // new data = 20

    return QCoreApplication::exec();
}
```



[^1]:还可运行时动态添加属性
